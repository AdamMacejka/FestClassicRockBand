<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Fest Classic Rock Band – rockové hity, ktoré nezabúdajú. Kapela hrajúca klasiku. Kontakt pre koncerty.">
  <meta property="og:title" content="Fest Classic Rock Band">
  <meta property="og:image" content="/images/uploads/cover.jpg">
  <meta property="og:description" content="Skúsená rocková kapela.">

  <title>Fest Classic Rock Band</title>

  <!-- Rockový / gotický štýl: UnifrakturCook pre nadpisy, Roboto Slab pre text -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=UnifrakturCook:wght@700&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet" />

  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
</head>
<body>
  <header class="hero" id="hero">
    <div class="logo-container">
      <img id="logo-image" src="" alt="Logo kapely" />
    </div>
  </header>

  <nav class="main-nav">
    <div class="nav-inner">
      <a href="#about">O nás</a>
      <a href="#members">Členovia</a>
      <a href="#concerts">Koncerty</a>
      <a href="#contact">Kontakt</a>
    </div>
  </nav>

  <section id="about" class="section">
    <h2>O nás</h2>
    <div id="about-text">
      <p>Text doplníme neskôr...</p>
    </div>
    <div class="social-inline">
      <a id="facebook-link" href="#" target="_blank" class="facebook">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <path d="M13.5 3H16V0h-3c-3.038 0-5 1.962-5 5v2H6v4h2v8h4v-8h3l1-4h-4V5c0-.551.448-1 1-1h2V3z"/>
        </svg>
        Facebook
      </a>
    </div>
  </section>

  <section id="members" class="section">
    <h2>Členovia</h2>
    <div class="members-grid">
      <!-- dynamicky doplnené cez JS -->
    </div>
  </section>

  <section id="concerts" class="section">
    <h2>Koncerty</h2>
    <p>Informácie o koncertoch doplníme čoskoro.</p>
  </section>

  <section id="contact" class="section">
    <h2>Kontakt</h2>
    <div class="contact-row">
      <p class="email">
        Email: <a id="contact-email" href="mailto:booking@festclassicrockband.com">booking@festclassicrockband.com</a>
      </p>
    </div>
  </section>

  <footer class="footer">
    <p>© 2025 Fest Classic Rock Band</p>
  </footer>

  <script>
    // ---------- HOMEPAGE ----------
    async function loadHomepage() {
      try {
        const res = await fetch('/content/homepage.yml');
        if (!res.ok) throw new Error('Nepodarilo sa stiahnuť homepage.yml: ' + res.status);
        const text = await res.text();
        const data = jsyaml.load(text);

        // Logo
        const logoEl = document.getElementById('logo-image');
        if (data.logo_image) {
          logoEl.src = data.logo_image;
          logoEl.alt = data.band_name || 'Fest Classic Rock Band';
          logoEl.style.display = 'block';
        } else {
          logoEl.style.display = 'none';
        }

        // Cover / placeholder
        const hero = document.getElementById('hero');
        let imageUrl = '';
        if (data.cover_image) {
          imageUrl = data.cover_image;
        } else if (data.placeholder_image) {
          imageUrl = data.placeholder_image;
        }
        if (imageUrl) {
          hero.style.backgroundImage = `url('${imageUrl}')`;
          hero.style.backgroundSize = 'cover';
          hero.style.backgroundPosition = 'center 35%';
        }

        // O nás (markdown)
        if (data.about_text) {
          const aboutEl = document.getElementById('about-text');
          if (window.marked) {
            if (typeof marked === 'function') {
              aboutEl.innerHTML = marked.parse ? marked.parse(data.about_text) : marked(data.about_text);
            } else {
              aboutEl.innerHTML = data.about_text;
            }
          } else {
            aboutEl.textContent = data.about_text;
          }
        }

        // Kontakt email
        if (data.contact_email) {
          const emailEl = document.getElementById('contact-email');
          emailEl.textContent = data.contact_email;
          emailEl.href = 'mailto:' + data.contact_email;
        }

        // Facebook (v sekcii O nás)
        if (data.facebook_url) {
          const fb = document.getElementById('facebook-link');
          fb.href = data.facebook_url;
          fb.style.display = 'inline-flex';
        } else {
          document.getElementById('facebook-link').style.display = 'none';
        }
      } catch (e) {
        console.error('Chyba pri načítaní homepage obsahu:', e);
      }
    }

    // ---------- MEMBERS ----------
    async function fetchMembers() {
      const repo = 'AdamMacejka/FestClassicRockBand';
      const branch = 'main';
      const apiBase = `https://api.github.com/repos/${repo}/contents/content/members?ref=${branch}`;

      try {
        const listRes = await fetch(apiBase);
        if (!listRes.ok) {
          console.error('Nepodarilo sa získať zoznam členov, status', listRes.status);
          if (listRes.status === 404) {
            document.querySelector('.members-grid').innerHTML = '<p>Žiadni členovia zatiaľ. Pridaj ich cez CMS.</p>';
          }
          return;
        }
        const files = await listRes.json();

        const members = [];
        for (const file of files) {
          if (!file.name.endsWith('.md')) continue;
          const mdRes = await fetch(file.download_url);
          if (!mdRes.ok) continue;
          const text = await mdRes.text();
          const match = text.match(/^---\s*([\s\S]*?)\s*---/);
          if (!match) continue;
          const frontmatter = match[1];
          const data = jsyaml.load(frontmatter);
          members.push({
            name: data.name,
            instrument: data.instrument,
            image: data.image,
          });
        }

        renderMembers(members);
      } catch (e) {
        console.error('Chyba pri načítaní členov:', e);
      }
    }

    function renderMembers(members) {
      const grid = document.querySelector('.members-grid');
      if (!grid) return;
      grid.innerHTML = '';

      if (!members || members.length === 0) {
        grid.innerHTML = '<p>Žiadni členovia nenájdení.</p>';
        return;
      }

      members.forEach(m => {
        const el = document.createElement('div');
        el.className = 'member';
        el.innerHTML = `
          <div class="photo">
            ${m.image ? `<img src="${m.image}" alt="${m.name}"/>` : `<div class="photo-placeholder"></div>`}
          </div>
          <h3>${m.name || '–'}</h3>
          <p>${m.instrument || ''}</p>
        `;
        grid.appendChild(el);
      });

      setupLightbox();
    }

    // ---------- CONCERTS ----------
    async function fetchConcerts() {
      const repo = 'AdamMacejka/FestClassicRockBand';
      const branch = 'main';
      const apiBase = `https://api.github.com/repos/${repo}/contents/content/concerts?ref=${branch}`;

      try {
        const listRes = await fetch(apiBase);
        const section = document.getElementById('concerts');
        if (!listRes.ok) {
          console.warn('Nepodarilo sa získať koncerty', listRes.status);
          return;
        }
        const files = await listRes.json();
        const concerts = [];

        for (const file of files) {
          if (!file.name.endsWith('.md')) continue;
          const mdRes = await fetch(file.download_url);
          if (!mdRes.ok) continue;
          const text = await mdRes.text();
          const match = text.match(/^---\s*([\s\S]*?)\s*---/);
          if (!match) continue;
          const frontmatter = match[1];
          const data = jsyaml.load(frontmatter);
          concerts.push({
            date: data.date,
            location: data.location,
            event_url: data.event_url,
            map_url: data.map_url,
          });
        }

        renderConcerts(concerts);
      } catch (e) {
        console.error('Chyba pri načítaní koncertov:', e);
      }
    }

    function renderConcerts(concerts) {
      const section = document.getElementById('concerts');
      if (!section) return;

      if (!concerts || concerts.length === 0) {
        section.innerHTML = '<h2>Koncerty</h2><p>Informácie o koncertoch doplníme čoskoro.</p>';
        return;
      }

      concerts.sort((a, b) => {
        const da = new Date(a.date);
        const db = new Date(b.date);
        return da - db;
      });

      const list = document.createElement('div');
      list.className = 'concert-list';

      concerts.forEach(c => {
        const card = document.createElement('div');
        card.className = 'concert-card';

        const dateObj = c.date ? new Date(c.date) : null;
        const dateStr = dateObj
          ? dateObj.toLocaleDateString('sk-SK', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' })
          : '';

        let inner = `<div class="concert-info">
            <div class="concert-date">${dateStr}</div>
            <div class="concert-location">${c.location || ''}</div>
            <div class="concert-links">`;

        if (c.event_url) {
          inner += `<a class="link-event" target="_blank" rel="noopener" href="${c.event_url}">Event</a>`;
        }
        if (c.map_url) {
          if (c.event_url) inner += ' | ';
          inner += `<a class="link-map" target="_blank" rel="noopener" href="${c.map_url}">Mapa</a>`;
        }

        inner += `</div></div>`;

        card.innerHTML = inner;
        list.appendChild(card);
      });

      section.innerHTML = '<h2>Koncerty</h2>';
      section.appendChild(list);
    }

    // ---------- LIGHTBOX ----------
    function setupLightbox() {
      document.querySelectorAll('.member').forEach(member => {
        member.addEventListener('click', () => {
          const img = member.querySelector('img');
          if (!img) return;

          const src = img.src;
          const alt = img.alt || '';

          const overlay = document.createElement('div');
          overlay.className = 'lightbox-overlay';

          const content = document.createElement('div');
          content.className = 'lightbox-content';

          const largeImg = document.createElement('img');
          largeImg.src = src;
          largeImg.alt = alt;
          largeImg.className = 'lightbox-img';

          const closeBtn = document.createElement('button');
          closeBtn.className = 'lightbox-close';
          closeBtn.innerHTML = '&times;';
          closeBtn.setAttribute('aria-label', 'Zatvoriť');

          closeBtn.addEventListener('click', () => {
            overlay.remove();
          });

          overlay.addEventListener('click', (e) => {
            if (e.target === overlay) overlay.remove();
          });

          document.addEventListener('keydown', function escHandler(e) {
            if (e.key === 'Escape') {
              overlay.remove();
              document.removeEventListener('keydown', escHandler);
            }
          });

          content.appendChild(largeImg);
          content.appendChild(closeBtn);
          overlay.appendChild(content);
          document.body.appendChild(overlay);
        });
      });
    }

    // ---------- INIT ----------
    document.addEventListener('DOMContentLoaded', () => {
      loadHomepage();
      fetchMembers();
      fetchConcerts();
    });
  </script>
</body>
</html>
